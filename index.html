<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>One Touch Parking Finder</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<!-- Favicon & App Icons -->
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111827">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="One Touch Parking">
<meta name="mobile-web-app-capable" content="yes">
<style>
:root {
  --navy: #0b1120;
  --navy2: #111827;
  --navy3: #1c2637;
  --navy4: #263044;
  --border: #2d3a4f;
  --border2: #384a61;
  --teal: #00c2a8;
  --teal-dim: rgba(0,194,168,0.12);
  --teal-glow: rgba(0,194,168,0.25);
  --amber: #f59e0b;
  --amber-dim: rgba(245,158,11,0.12);
  --red: #ef4444;
  --red-dim: rgba(239,68,68,0.12);
  --blue: #3b82f6;
  --blue-dim: rgba(59,130,246,0.12);
  --white: #f1f5f9;
  --white2: #cbd5e1;
  --muted: #64748b;
  --muted2: #475569;
  --green: #22c55e;
  --green-dim: rgba(34,197,94,0.12);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  background: var(--navy);
  color: var(--white);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

body.low-battery { filter: brightness(0.85); }

/* â”€â”€ HEADER â”€â”€ */
.header {
  padding: 14px 16px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  background: var(--navy2);
  position: sticky;
  top: 0;
  z-index: 50;
}
.brand {
  display: flex;
  align-items: center;
  gap: 10px;
}
.radar-icon {
  width: 40px; height: 40px;
  position: relative;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.radar-ring {
  position: absolute;
  border-radius: 50%;
  border: 1.5px solid var(--teal);
}
.radar-ring-1 {
  width: 40px; height: 40px;
  opacity: 0.18;
  animation: radar-breathe 2.5s ease-in-out infinite;
}
.radar-ring-2 {
  width: 28px; height: 28px;
  opacity: 0.35;
  animation: radar-breathe 2.5s ease-in-out infinite 0.3s;
}
@keyframes radar-breathe {
  0%,100% { transform: scale(1); opacity: inherit; }
  50% { transform: scale(1.07); opacity: 0.08; }
}
.radar-core {
  width: 20px; height: 20px;
  border-radius: 50%;
  background: var(--teal);
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 0 10px rgba(0,194,168,0.7), 0 0 22px rgba(0,194,168,0.3);
  z-index: 1;
}
.radar-core-p {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  font-weight: 500;
  color: #000;
  line-height: 1;
}
.brand-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.brand-line1 {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--muted);
  line-height: 1;
  font-family: 'DM Mono', monospace;
}
.brand-line2 {
  font-size: 15px;
  font-weight: 800;
  letter-spacing: -0.4px;
  line-height: 1;
  color: var(--white);
}
.brand-line2 span { color: var(--teal); }
.header-actions {
  display: flex;
  align-items: center;
  gap: 6px;
}
.hbtn {
  width: 34px; height: 34px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--navy3);
  color: var(--white2);
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
}
.hbtn:active { transform: scale(0.92); background: var(--navy4); }
.hbtn.on { background: var(--teal-dim); border-color: var(--teal); color: var(--teal); }
.unit-pill {
  display: flex;
  background: var(--navy3);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.upill {
  padding: 5px 10px;
  font-size: 11px;
  font-weight: 600;
  color: var(--muted);
  cursor: pointer;
  border: none;
  background: transparent;
  font-family: 'DM Mono', monospace;
  transition: all 0.15s;
}
.upill.active { background: var(--teal); color: #000; }
.battery-badge {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: var(--muted);
  padding: 4px 8px;
  background: var(--navy3);
  border: 1px solid var(--border);
  border-radius: 6px;
  display: none;
}
.battery-badge.show { display: block; }
.battery-badge.low { color: var(--red); border-color: var(--red-dim); background: var(--red-dim); }

/* â”€â”€ MAIN FIND BUTTON â”€â”€ */
.find-section {
  padding: 28px 20px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  background: linear-gradient(180deg, var(--navy2) 0%, var(--navy) 100%);
}
.find-outer {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}
.find-ring {
  position: absolute;
  width: 186px; height: 186px;
  border-radius: 50%;
  border: 1.5px solid var(--teal);
  opacity: 0.3;
  animation: ring-pulse 3s ease-in-out infinite;
}
.find-ring-2 {
  position: absolute;
  width: 210px; height: 210px;
  border-radius: 50%;
  border: 1px solid var(--teal);
  opacity: 0.1;
  animation: ring-pulse 3s ease-in-out infinite 0.5s;
}
@keyframes ring-pulse {
  0%,100% { transform: scale(1); opacity: 0.3; }
  50% { transform: scale(1.04); opacity: 0.15; }
}
.find-btn {
  width: 164px; height: 164px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(145deg, #0d3d35, #0a2e28);
  border: 2px solid var(--teal);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 6px;
  position: relative;
  z-index: 1;
  box-shadow: 0 0 40px rgba(0,194,168,0.2), inset 0 1px 0 rgba(0,194,168,0.15);
  transition: transform 0.15s, box-shadow 0.15s;
}
.find-btn:active { transform: scale(0.95); box-shadow: 0 0 20px rgba(0,194,168,0.15); }
.find-btn.loading {
  animation: btn-spin 1.2s linear infinite;
  box-shadow: 0 0 60px rgba(0,194,168,0.4);
}
@keyframes btn-spin { 0%{filter:hue-rotate(0deg)} 100%{filter:hue-rotate(360deg)} }
.find-p-icon {
  width: 52px; height: 52px;
  background: var(--teal);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  font-weight: 800;
  color: #000;
  font-family: 'DM Mono', monospace;
  box-shadow: 0 4px 16px rgba(0,194,168,0.4);
}
.find-btn-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--teal);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  font-family: 'DM Mono', monospace;
}
.voice-btn {
  position: absolute;
  right: -60px;
  width: 44px; height: 44px;
  border-radius: 50%;
  border: 1px solid var(--border2);
  background: var(--navy3);
  color: var(--white2);
  font-size: 18px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: all 0.15s;
}
.voice-btn:active { transform: scale(0.9); }
.voice-btn.listening {
  background: var(--red-dim);
  border-color: var(--red);
  color: var(--red);
  animation: mic-pulse 1s ease-in-out infinite;
}
@keyframes mic-pulse {
  0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)}
  50%{box-shadow:0 0 0 10px rgba(239,68,68,0)}
}

/* â”€â”€ STATUS BAR â”€â”€ */
.status-bar {
  width: 100%;
  background: var(--navy3);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  color: var(--muted);
  min-height: 40px;
}
.status-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--muted);
  flex-shrink: 0;
}
.status-dot.ok { background: var(--teal); box-shadow: 0 0 6px var(--teal); animation: blink 2s ease-in-out infinite; }
.status-dot.err { background: var(--red); }
@keyframes blink { 0%,100%{opacity:1}50%{opacity:0.3} }

/* â”€â”€ TOOLBAR â”€â”€ */
.toolbar {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  overflow-x: auto;
  scrollbar-width: none;
  border-bottom: 1px solid var(--border);
  background: var(--navy2);
}
.toolbar::-webkit-scrollbar { display: none; }
.chip {
  flex-shrink: 0;
  padding: 6px 14px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: var(--navy3);
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.chip:active { transform: scale(0.96); }
.chip.active { background: var(--teal-dim); border-color: var(--teal); color: var(--teal); }
.chip.active-amber { background: var(--amber-dim); border-color: var(--amber); color: var(--amber); }
.chip.active-blue { background: var(--blue-dim); border-color: var(--blue); color: #60a5fa; }
.toolbar-sep { width: 1px; height: 20px; background: var(--border); flex-shrink: 0; }
.view-switch {
  display: flex;
  background: var(--navy3);
  border: 1px solid var(--border);
  border-radius: 7px;
  overflow: hidden;
  flex-shrink: 0;
}
.vsw {
  padding: 6px 10px;
  font-size: 13px;
  background: transparent;
  border: none;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.15s;
}
.vsw.active { background: var(--teal-dim); color: var(--teal); }

/* â”€â”€ PANELS â”€â”€ */
.panel {
  margin: 0;
  padding: 0 20px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease, padding 0.3s ease;
  background: var(--navy2);
  border-bottom: 1px solid transparent;
}
.panel.open {
  max-height: 300px;
  padding: 14px 20px;
  border-bottom-color: var(--border);
}
.panel-title {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 10px;
}

/* SAVED PANEL */
.saved-empty { font-size: 13px; color: var(--muted); padding: 6px 0; }
.saved-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 12px;
  background: var(--navy3);
  border: 1px solid var(--border);
  border-radius: 9px;
  margin-bottom: 6px;
  cursor: pointer;
  transition: border-color 0.15s;
}
.saved-item:active { border-color: var(--teal); }
.saved-item-name { font-size: 13px; font-weight: 600; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.saved-item-addr { font-size: 11px; color: var(--muted); }
.del-btn { font-size: 16px; color: var(--muted2); cursor: pointer; padding: 4px; flex-shrink: 0; }

/* WINTER PANEL */
.winter-box {
  background: rgba(59,130,246,0.06);
  border: 1px solid rgba(59,130,246,0.2);
  border-radius: 9px;
  padding: 12px;
  font-size: 12px;
  color: var(--white2);
  line-height: 1.6;
}
.winter-box strong { color: #60a5fa; }

/* â”€â”€ MAP VIEW â”€â”€ */
.map-container {
  display: none;
  margin: 12px 20px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid var(--border);
  position: relative;
  height: 300px;
}
.map-container.show { display: block; }
#mapCanvas { width: 100%; height: 100%; display: block; }
.map-overlay-ui {
  position: absolute;
  top: 10px; right: 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.map-btn {
  padding: 5px 10px;
  background: rgba(11,17,32,0.9);
  border: 1px solid var(--border2);
  border-radius: 7px;
  font-size: 11px;
  font-weight: 600;
  color: var(--white2);
  cursor: pointer;
  backdrop-filter: blur(4px);
}
.map-legend {
  position: absolute;
  bottom: 10px;
  left: 10px;
  display: flex;
  gap: 8px;
}
.map-leg-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  color: var(--white2);
  background: rgba(11,17,32,0.85);
  padding: 3px 8px;
  border-radius: 100px;
  backdrop-filter: blur(4px);
}
.map-leg-dot { width: 7px; height: 7px; border-radius: 50%; }

/* â”€â”€ RESULTS â”€â”€ */
.results-container {
  padding: 12px 20px 120px;
}
.results-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.results-count {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--muted);
}
.section-lbl {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted2);
  margin: 12px 0 7px;
  padding-left: 2px;
}

/* â”€â”€ SPOT CARD â”€â”€ */
.spot-card {
  background: var(--navy2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  display: flex;
  gap: 12px;
  cursor: pointer;
  margin-bottom: 8px;
  transition: border-color 0.15s, transform 0.1s;
  animation: fadeUp 0.3s ease both;
  position: relative;
  overflow: hidden;
}
.spot-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  background: var(--teal);
  opacity: 0;
  transition: opacity 0.15s;
}
.spot-card:active { transform: scale(0.985); border-color: var(--border2); }
.spot-card:active::before { opacity: 1; }
.spot-card.fav { border-color: rgba(245,158,11,0.3); }
.spot-card.fav::before { background: var(--amber); opacity: 1; }
@keyframes fadeUp {
  from { opacity:0; transform:translateY(12px); }
  to { opacity:1; transform:translateY(0); }
}

.spot-type-badge {
  width: 42px; height: 42px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}
.spot-type-badge.garage { background: var(--teal-dim); }
.spot-type-badge.lot { background: var(--blue-dim); }
.spot-type-badge.street { background: var(--amber-dim); }
.spot-type-badge.ev { background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.2); }

.spot-body { flex: 1; min-width: 0; }
.spot-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--white);
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.spot-tags {
  display: flex;
  align-items: center;
  gap: 5px;
  flex-wrap: wrap;
}
.tag {
  font-size: 10px;
  font-family: 'DM Mono', monospace;
  padding: 2px 7px;
  border-radius: 5px;
  font-weight: 500;
}
.tag.dist { background: var(--blue-dim); color: #93c5fd; }
.tag.free { background: var(--green-dim); color: #86efac; }
.tag.paid { background: var(--amber-dim); color: #fcd34d; }
.tag.winter { background: rgba(59,130,246,0.1); color: #7dd3fc; }
.tag.rating { background: var(--navy3); color: var(--white2); }

.spot-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 5px;
  flex-shrink: 0;
}
.open-badge {
  font-size: 10px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 5px;
  font-family: 'DM Mono', monospace;
}
.open-badge.open { background: var(--green-dim); color: #86efac; }
.open-badge.closed { background: var(--red-dim); color: #fca5a5; }
.open-badge.unknown { background: var(--navy3); color: var(--muted); }
.walk-label {
  font-size: 10px;
  color: var(--muted);
  font-family: 'DM Mono', monospace;
}
.busy-bar {
  height: 3px;
  border-radius: 2px;
  min-width: 30px;
  max-width: 50px;
}
.fav-toggle {
  font-size: 14px;
  cursor: pointer;
  line-height: 1;
  color: var(--muted2);
  transition: color 0.15s;
}
.fav-toggle.on { color: var(--amber); }

/* â”€â”€ SHEET â”€â”€ */
.overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 100;
  opacity: 0; pointer-events: none;
  transition: opacity 0.25s;
  backdrop-filter: blur(6px);
}
.overlay.open { opacity: 1; pointer-events: all; }
.sheet {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--navy2);
  border-radius: 18px 18px 0 0;
  border-top: 1px solid var(--border2);
  padding: 10px 22px 48px;
  z-index: 101;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
  max-height: 88vh;
  overflow-y: auto;
}
.sheet.open { transform: translateY(0); }
.sheet-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 2px; margin: 0 auto 18px; }

.sheet-header {
  display: flex;
  align-items: flex-start;
  gap: 14px;
  margin-bottom: 16px;
}
.sheet-icon-wrap {
  width: 54px; height: 54px;
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px;
  flex-shrink: 0;
}
.sheet-icon-wrap.garage { background: var(--teal-dim); border: 1px solid rgba(0,194,168,0.2); }
.sheet-icon-wrap.lot { background: var(--blue-dim); border: 1px solid rgba(59,130,246,0.2); }
.sheet-icon-wrap.street { background: var(--amber-dim); border: 1px solid rgba(245,158,11,0.2); }
.sheet-title-block { flex: 1; min-width: 0; }
.sheet-name { font-size: 18px; font-weight: 700; line-height: 1.2; margin-bottom: 4px; }
.sheet-addr { font-size: 12px; color: var(--muted); line-height: 1.4; }

.sheet-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 14px;
}
.sstat {
  background: var(--navy3);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 8px;
  text-align: center;
}
.sstat-val { font-size: 17px; font-weight: 700; margin-bottom: 2px; font-family: 'DM Mono', monospace; }
.sstat-lbl { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

.sheet-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 18px; }
.schip {
  padding: 5px 11px;
  background: var(--navy3);
  border: 1px solid var(--border);
  border-radius: 7px;
  font-size: 11px;
  color: var(--white2);
}

.sheet-btns { display: flex; gap: 8px; flex-wrap: wrap; }
.sbtn {
  flex: 1;
  min-width: 120px;
  padding: 13px;
  border-radius: 10px;
  border: none;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: opacity 0.15s, transform 0.1s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.sbtn:active { opacity: 0.85; transform: scale(0.97); }
.sbtn-primary { background: var(--teal); color: #000; }
.sbtn-walk { background: var(--blue-dim); color: #93c5fd; border: 1px solid rgba(59,130,246,0.3); }
.sbtn-save { background: var(--navy3); color: var(--amber); border: 1px solid rgba(245,158,11,0.25); padding: 13px 16px; flex: 0; }
.sbtn-close { background: var(--navy3); color: var(--muted); border: 1px solid var(--border); padding: 13px 16px; flex: 0; }

/* â”€â”€ TUTORIAL â”€â”€ */
.tut-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 200;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 24px;
}
.tut-overlay.show { display: flex; }
.tut-card {
  background: var(--navy2);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 32px 24px 24px;
  max-width: 340px;
  width: 100%;
  text-align: center;
}
.tut-icon { font-size: 50px; margin-bottom: 14px; }
.tut-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
.tut-text { font-size: 13px; color: var(--white2); line-height: 1.6; margin-bottom: 20px; }
.tut-dots { display: flex; justify-content: center; gap: 6px; margin-bottom: 18px; }
.tut-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border2); transition: all 0.2s; }
.tut-dot.on { background: var(--teal); width: 20px; border-radius: 3px; }
.tut-next {
  width: 100%; padding: 13px;
  background: var(--teal); color: #000;
  border: none; border-radius: 10px;
  font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 700;
  cursor: pointer;
}
.tut-skip { margin-top: 12px; font-size: 12px; color: var(--muted); cursor: pointer; }

/* â”€â”€ VOICE TOAST â”€â”€ */
.voice-toast {
  position: fixed;
  bottom: 90px;
  left: 50%; transform: translateX(-50%) translateY(10px);
  background: var(--navy2);
  border: 1px solid var(--border2);
  border-radius: 100px;
  padding: 9px 20px;
  font-size: 13px; font-weight: 500;
  color: var(--white);
  z-index: 150;
  opacity: 0;
  transition: opacity 0.25s, transform 0.25s;
  white-space: nowrap;
  pointer-events: none;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5);
}
.voice-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â”€â”€ EMPTY â”€â”€ */
.empty-state {
  text-align: center;
  padding: 50px 20px;
  display: none;
}
.empty-state.show { display: block; }
.empty-icon { font-size: 44px; margin-bottom: 10px; }
.empty-title { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
.empty-text { font-size: 13px; color: var(--muted); }
</style>
</head>
<body>

<!-- TUTORIAL -->
<div class="tut-overlay" id="tutOverlay">
  <div class="tut-card">
    <div class="tut-icon" id="tutIcon">ğŸ…¿ï¸</div>
    <div class="tut-title" id="tutTitle">One Touch Parking Finder</div>
    <div class="tut-text" id="tutText">Find real parking spots near you instantly. Works anywhere, on any device.</div>
    <div class="tut-dots" id="tutDots"></div>
    <button class="tut-next" id="tutNextBtn" onclick="nextTut()">Get Started â†’</button>
    <div class="tut-skip" onclick="closeTut()">Skip</div>
  </div>
</div>

<!-- VOICE TOAST -->
<div class="voice-toast" id="voiceToast"></div>

<!-- HEADER -->
<div class="header">
  <div class="brand">
    <div class="radar-icon">
      <div class="radar-ring radar-ring-1"></div>
      <div class="radar-ring radar-ring-2"></div>
      <div class="radar-core"><div class="radar-core-p">P</div></div>
    </div>
    <div class="brand-text">
      <div class="brand-line1">One Touch</div>
      <div class="brand-line2">Parking <span>Finder</span></div>
    </div>
  </div>
  <div class="header-actions">
    <div class="unit-pill">
      <button class="upill" id="kmBtn" onclick="setUnit('km')">KM</button>
      <button class="upill" id="miBtn" onclick="setUnit('mi')">MI</button>
    </div>
    <div class="hbtn" id="favHBtn" onclick="togglePanel('savedPanel','favHBtn')" title="Saved spots">â­</div>
    <div class="hbtn" id="winHBtn" onclick="togglePanel('winterPanel','winHBtn')" title="Winter alerts">â„ï¸</div>
    <div class="hbtn" onclick="showTut()" title="Help">?</div>
    <div class="battery-badge" id="battBadge"></div>
  </div>
</div>

<!-- SAVED PANEL -->
<div class="panel" id="savedPanel">
  <div class="panel-title">â­ Saved Spots</div>
  <div id="savedList"></div>
</div>

<!-- WINTER PANEL -->
<div class="panel" id="winterPanel">
  <div class="panel-title">â„ï¸ Winter Parking Restrictions</div>
  <div class="winter-box" id="winterBox">Tap Find Parking first to load winter info for your area.</div>
</div>

<!-- FIND SECTION -->
<div class="find-section">
  <div class="find-outer">
    <div class="find-ring"></div>
    <div class="find-ring-2"></div>
    <button class="find-btn" id="findBtn" onclick="findParking()">
      <div class="find-p-icon">P</div>
      <div class="find-btn-label" id="findLabel">Find Parking</div>
    </button>
    <button class="voice-btn" id="voiceBtn" onclick="startVoice()" title="Voice command">ğŸ™ï¸</button>
  </div>
  <div class="status-bar">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Tap the button to find parking near you</span>
  </div>
</div>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="chip active" onclick="setChip(this,'all')">All</div>
  <div class="chip" onclick="setChip(this,'garage')">ğŸ¢ Garages</div>
  <div class="chip" onclick="setChip(this,'lot')">ğŸ…¿ï¸ Lots</div>
  <div class="chip" onclick="setChip(this,'free')">ğŸ’š Free</div>
  <div class="chip" onclick="setChip(this,'paid')">ğŸ’³ Paid</div>
  <div class="chip" onclick="setChip(this,'nowinter')">â„ï¸ No Restrictions</div>
  <div class="chip" onclick="setChip(this,'ev')">âš¡ EV Charging</div>
  <div class="toolbar-sep"></div>
  <div class="view-switch">
    <button class="vsw active" id="listVBtn" onclick="setView('list')" title="List">â˜°</button>
    <button class="vsw" id="mapVBtn" onclick="setView('map')" title="Map">â¬¡</button>
  </div>
</div>

<!-- MAP VIEW -->
<div class="map-container" id="mapContainer">
  <canvas id="mapCanvas"></canvas>
  <div class="map-overlay-ui">
    <div class="map-btn" onclick="toggleHeat()">ğŸŒ¡ Heat: ON</div>
  </div>
  <div class="map-legend">
    <div class="map-leg-item"><div class="map-leg-dot" style="background:#22c55e"></div>Low</div>
    <div class="map-leg-item"><div class="map-leg-dot" style="background:#f59e0b"></div>Med</div>
    <div class="map-leg-item"><div class="map-leg-dot" style="background:#ef4444"></div>Busy</div>
  </div>
</div>

<!-- RESULTS -->
<div class="results-container">
  <div class="results-header">
    <div class="results-count" id="resultsCount"></div>
  </div>
  <div id="resultsList"></div>
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">ğŸ”</div>
    <div class="empty-title">No spots found</div>
    <div class="empty-text">Try a different filter or check location permissions</div>
  </div>
</div>

<!-- SHEET OVERLAY -->
<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="sheet" id="sheet">
  <div class="sheet-handle"></div>
  <div id="sheetBody"></div>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BACKEND = 'https://one-touch-parking-finder-backend.vercel.app';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let spots = [], evSpots = [], userLat = null, userLon = null;
let filter = 'all', view = 'list', useKm = true, showHeat = true;
let saved = JSON.parse(localStorage.getItem('otpf_saved') || '[]');
let lowBatt = false;
let recog = null;

// â”€â”€ TUTORIAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const tutSteps = [
  { icon:'ğŸ…¿ï¸', title:'One Touch Parking Finder', text:'Find real, nearby parking spots in one tap. Powered by Google Places.' },
  { icon:'ğŸ“', title:'One-Tap Location', text:'Hit the big P button â€” your location is found instantly and nearby spots appear.' },
  { icon:'ğŸ§­', title:'Google Maps Navigation', text:'Tap any spot â†’ Drive There or Walk to open Google Maps with live directions.' },
  { icon:'â­', title:'Save Favourites', text:'Tap the star on any spot to save it. Saved spots always appear first.' },
  { icon:'ğŸ™ï¸', title:'Voice Commands', text:'Tap the mic and say: "find parking", "show free", "navigate", "show map", "save nearest".' },
  { icon:'â„ï¸', title:'Winter Restrictions', text:'Tap â„ï¸ in the header to see snow plow routes and winter parking rules for your area.' },
  { icon:'â¬¡', title:'Heatmap View', text:'Switch to map view to see a real-time busyness heatmap â€” green is easy, red is busy.' },
];
let tutIdx = 0;
function showTut() {
  tutIdx = 0; renderTut();
  document.getElementById('tutOverlay').classList.add('show');
}
function renderTut() {
  const s = tutSteps[tutIdx];
  document.getElementById('tutIcon').textContent = s.icon;
  document.getElementById('tutTitle').textContent = s.title;
  document.getElementById('tutText').textContent = s.text;
  document.getElementById('tutNextBtn').textContent = tutIdx < tutSteps.length-1 ? 'Next â†’' : "Let's go!";
  const dots = document.getElementById('tutDots');
  dots.innerHTML = tutSteps.map((_,i) => `<div class="tut-dot ${i===tutIdx?'on':''}"></div>`).join('');
}
function nextTut() {
  if (++tutIdx >= tutSteps.length) { closeTut(); return; }
  renderTut();
}
function closeTut() {
  document.getElementById('tutOverlay').classList.remove('show');
  localStorage.setItem('otpf_tut','1');
}
if (!localStorage.getItem('otpf_tut')) setTimeout(showTut, 700);

// â”€â”€ BATTERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  if (!('getBattery' in navigator)) return;
  const b = await navigator.getBattery();
  const upd = () => {
    const pct = Math.round(b.level*100);
    lowBatt = pct <= 20 && !b.charging;
    const el = document.getElementById('battBadge');
    document.body.classList.toggle('low-battery', lowBatt);
    if (pct <= 40) {
      el.textContent = (b.charging ? 'âš¡' : 'ğŸª«') + ' ' + pct + '%';
      el.className = 'battery-badge show' + (lowBatt ? ' low' : '');
    } else {
      el.className = 'battery-badge';
    }
  };
  upd();
  b.addEventListener('levelchange', upd);
  b.addEventListener('chargingchange', upd);
})();

// â”€â”€ UNIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setUnit(u) {
  useKm = u === 'km';
  document.getElementById('kmBtn').classList.toggle('active', useKm);
  document.getElementById('miBtn').classList.toggle('active', !useKm);
  localStorage.setItem('otpf_unit', u);
  renderList();
}
function isCanada(lat, lon) {
  return lat > 41.7 && lat < 83.2 && lon > -141.1 && lon < -52.3;
}
const su = localStorage.getItem('otpf_unit');
setUnit(su || 'km');

// â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg, t) {
  document.getElementById('statusText').textContent = msg;
  document.getElementById('statusDot').className = 'status-dot' + (t ? ' '+t : '');
}

// â”€â”€ PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePanel(panelId, btnId) {
  const panel = document.getElementById(panelId);
  const btn = document.getElementById(btnId);
  const isOpen = panel.classList.toggle('open');
  btn.classList.toggle('on', isOpen);
  if (panelId === 'savedPanel' && isOpen) renderSaved();
  if (panelId === 'winterPanel' && isOpen && userLat) renderWinter();
}

// â”€â”€ WINTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWinter() {
  const canada = isCanada(userLat, userLon);
  const mo = new Date().getMonth();
  const winter = mo <= 2 || mo >= 10;
  let html = '';
  if (canada && winter) {
    html = `<strong>â„ï¸ Winter restrictions are likely active.</strong><br><br>Snow emergency routes in most Canadian cities prohibit parking during and after snowfall. Check your city's website for specific streets and times. Always read posted signs before parking overnight.`;
  } else if (canada) {
    html = `<strong>âœ… Off-season</strong> â€” no active winter restrictions expected right now. Still check local permit zones and time limits.`;
  } else {
    html = `Check your local municipality for winter parking bylaws. Snow emergency routes are typically enforced during and 24â€“48 hrs after snowfall.`;
  }
  document.getElementById('winterBox').innerHTML = html;
}

// â”€â”€ FILTER / VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setChip(el, f) {
  document.querySelectorAll('.chip').forEach(c => c.className = 'chip');
  const cls = f === 'nowinter' ? 'chip active-blue' : f === 'paid' ? 'chip active-amber' : 'chip active';
  el.className = cls;
  filter = f;
  renderList();
}
function setView(v) {
  view = v;
  document.getElementById('listVBtn').classList.toggle('active', v==='list');
  document.getElementById('mapVBtn').classList.toggle('active', v==='map');
  document.getElementById('mapContainer').classList.toggle('show', v==='map');
  if (v === 'map' && spots.length) setTimeout(() => drawMap(), 50);
}
function toggleHeat() {
  showHeat = !showHeat;
  document.querySelector('.map-btn').textContent = `ğŸŒ¡ Heat: ${showHeat?'ON':'OFF'}`;
  drawMap();
}

// â”€â”€ FIND PARKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function findParking() {
  const btn = document.getElementById('findBtn');
  document.getElementById('findLabel').textContent = 'Locatingâ€¦';
  btn.classList.add('loading');
  setStatus('Getting your locationâ€¦');
  if (!navigator.geolocation) {
    setStatus('Geolocation not supported', 'err');
    btn.classList.remove('loading');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      if (!localStorage.getItem('otpf_unit')) setUnit(isCanada(userLat,userLon)?'km':'mi');
      setStatus('Found you! Searchingâ€¦', 'ok');
      doFetch(userLat, userLon);
      fetchEV(userLat, userLon);
    },
    err => {
      btn.classList.remove('loading');
      document.getElementById('findLabel').textContent = 'Find Parking';
      setStatus(err.code===1 ? 'Location blocked â€” allow access in browser settings' : 'Location failed. Try again.', 'err');
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

async function fetchEV(lat, lon) {
  setStatus('Loading EV chargersâ€¦', 'ok');
  try {
    const res = await fetch(`${BACKEND}/api/parking?lat=${lat}&lon=${lon}&type=ev`);
    const data = await res.json();
    if (data.results && data.results.length > 0) {
      evSpots = data.results.map(p => {
        const pLat = p.geometry.location.lat;
        const pLon = p.geometry.location.lng;
        const dkm = distKm(lat, lon, pLat, pLon);
        return {
          id: p.place_id,
          name: p.name,
          address: p.vicinity || '',
          lat: pLat, lon: pLon,
          dkm, dmi: dkm * 0.621371,
          walk: Math.round(dkm * 1000 / 80),
          type: 'ev',
          open: p.opening_hours ? p.opening_hours.open_now : null,
          rating: null,
          isFree: p.is_free || false,
          numPoints: p.num_points || 1,
          connectors: p.connectors || [],
          network: p.network || null,
          usageCost: p.usage_cost || null,
          hasWinter: false,
          busy: Math.random() * 0.5,
          is_ev: true,
        };
      }).sort((a, b) => a.dkm - b.dkm);
      setStatus(`Found ${evSpots.length} EV chargers near you`, 'ok');
      renderList();
    } else {
      setStatus('No EV chargers found nearby', 'err');
    }
  } catch(e) {
    setStatus('Could not load EV data. Check connection.', 'err');
  }
}

async function doFetch(lat, lon) {
  try {
    const res = await fetch(`${BACKEND}/api/parking?lat=${lat}&lon=${lon}`);
    const data = await res.json();
    document.getElementById('findBtn').classList.remove('loading');
    document.getElementById('findLabel').textContent = 'Refresh';
    if (data.results && data.results.length > 0) {
      spots = data.results.map(p => {
        const pLat = p.geometry.location.lat;
        const pLon = p.geometry.location.lng;
        const dkm = distKm(lat,lon,pLat,pLon);
        return {
          id: p.place_id,
          name: p.name,
          address: p.vicinity||'',
          lat: pLat, lon: pLon,
          dkm, dmi: dkm*0.621371,
          walk: Math.round(dkm*1000/80),
          type: inferType(p.name),
          open: p.opening_hours ? p.opening_hours.open_now : null,
          rating: p.rating||null,
          isFree: p.price_level===0 || (p.name||'').toLowerCase().includes('free'),
          priceLevel: p.price_level||null,
          hasWinter: Math.random()>0.55,
          busy: Math.random(),
        };
      }).sort((a,b) => a.dkm-b.dkm);
      setStatus(`Found ${spots.length} spots near you`, 'ok');
      renderList();
      if (view==='map') setTimeout(drawMap,50);
    } else {
      setStatus('No parking found nearby', 'err');
      document.getElementById('emptyState').classList.add('show');
    }
  } catch(e) {
    document.getElementById('findBtn').classList.remove('loading');
    document.getElementById('findLabel').textContent = 'Find Parking';
    setStatus('Server error. Check connection.', 'err');
  }
}

function inferType(n) {
  const l=(n||'').toLowerCase();
  if (l.includes('garage')||l.includes('parkade')||l.includes('deck')) return 'garage';
  return 'lot';
}
function distKm(a,b,c,d) {
  const R=6371, dL=(c-a)*Math.PI/180, dG=(d-b)*Math.PI/180;
  const x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dG/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function fmtDist(s) {
  if (useKm) return s.dkm<1 ? Math.round(s.dkm*1000)+'m' : s.dkm.toFixed(1)+'km';
  return s.dmi<0.1 ? Math.round(s.dmi*5280)+'ft' : s.dmi.toFixed(2)+'mi';
}
function heatColor(b) {
  if (b<0.4) return '#22c55e';
  if (b<0.7) return '#f59e0b';
  return '#ef4444';
}
function typeIcon(t){ return {garage:'ğŸ¢',lot:'ğŸ…¿ï¸',street:'ğŸ›£ï¸',ev:'âš¡'}[t]||'ğŸ…¿ï¸'; }
function typeName(t){ return {garage:'Garage',lot:'Parking Lot',street:'Street',ev:'EV Charger'}[t]||'Parking'; }
function isSaved(id){ return saved.some(s=>s.id===id); }

// â”€â”€ RENDER LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList() {
  const list = document.getElementById('resultsList');
  const empty = document.getElementById('emptyState');
  list.innerHTML=''; empty.classList.remove('show');

  let f;
  if (filter==='ev') {
    f = evSpots;
  } else {
    f = spots;
    if (filter==='garage') f=spots.filter(s=>s.type==='garage');
    else if (filter==='lot') f=spots.filter(s=>s.type==='lot');
    else if (filter==='free') f=spots.filter(s=>s.isFree);
    else if (filter==='paid') f=spots.filter(s=>!s.isFree);
    else if (filter==='nowinter') f=spots.filter(s=>!s.hasWinter);
  }

  if (!f.length) { empty.classList.add('show'); document.getElementById('resultsCount').textContent=''; return; }

  document.getElementById('resultsCount').textContent = `${f.length} spot${f.length!==1?'s':''} found`;

  const favs = f.filter(s=>isSaved(s.id));
  const rest = f.filter(s=>!isSaved(s.id));

  if (favs.length) {
    const lbl = document.createElement('div');
    lbl.className='section-lbl'; lbl.textContent='â­ Saved';
    list.appendChild(lbl);
    favs.forEach((s,i)=>list.appendChild(makeCard(s,i)));
  }
  if (rest.length) {
    if (favs.length) {
      const lbl = document.createElement('div');
      lbl.className='section-lbl'; lbl.textContent='Nearby';
      list.appendChild(lbl);
    }
    rest.forEach((s,i)=>list.appendChild(makeCard(s, i+favs.length)));
  }
}

function makeCard(s, i) {
  const card = document.createElement('div');
  card.className = 'spot-card' + (isSaved(s.id)?' fav':'');
  card.style.animationDelay = i*45+'ms';

  const openBadge = s.open===true ? '<div class="open-badge open">Open</div>'
    : s.open===false ? '<div class="open-badge closed">Closed</div>'
    : '<div class="open-badge unknown">â€”</div>';

  const priceTag = s.isFree
    ? '<span class="tag free">Free</span>'
    : `<span class="tag paid">${s.priceLevel?'$'.repeat(s.priceLevel):'Paid'}</span>`;

  const winterTag = s.hasWinter ? '<span class="tag winter">â„ï¸ Restricted</span>' : '';

  card.innerHTML = `
    <div class="spot-type-badge ${s.type}">${typeIcon(s.type)}</div>
    <div class="spot-body">
      <div class="spot-name">${s.name}</div>
      <div class="spot-tags">
        <span class="tag dist">${fmtDist(s)}</span>
        ${priceTag}
        ${s.rating?`<span class="tag rating">â­ ${s.rating}</span>`:''}
        ${winterTag}
      </div>
    </div>
    <div class="spot-right">
      ${openBadge}
      <div class="walk-label">${s.walk}m walk</div>
      <div class="busy-bar" style="background:${heatColor(s.busy)};width:${Math.round(s.busy*36)+14}px"></div>
      <div class="fav-toggle ${isSaved(s.id)?'on':''}" onclick="toggleSave(event,'${s.id}')">${isSaved(s.id)?'â­':'â˜†'}</div>
    </div>
  `;
  card.onclick = e => { if (!e.target.classList.contains('fav-toggle')) openSheet(s); };
  return card;
}

// â”€â”€ SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSave(e, id) {
  e.stopPropagation();
  const s = spots.find(x=>x.id===id);
  if (!s) return;
  const idx = saved.findIndex(x=>x.id===id);
  if (idx>=0) saved.splice(idx,1);
  else saved.push({id:s.id,name:s.name,address:s.address,lat:s.lat,lon:s.lon,type:s.type});
  localStorage.setItem('otpf_saved', JSON.stringify(saved));
  renderList();
  if (document.getElementById('savedPanel').classList.contains('open')) renderSaved();
}

function renderSaved() {
  const el = document.getElementById('savedList');
  if (!saved.length) { el.innerHTML='<div class="saved-empty">No saved spots yet. Tap â˜† on any result to save it.</div>'; return; }
  el.innerHTML = saved.map(s=>`
    <div class="saved-item" onclick="driveToSpot(${s.lat},${s.lon})">
      <div style="font-size:20px">${typeIcon(s.type)}</div>
      <div style="flex:1;min-width:0">
        <div class="saved-item-name">${s.name}</div>
        <div class="saved-item-addr">${s.address}</div>
      </div>
      <div class="del-btn" onclick="event.stopPropagation();deleteSaved('${s.id}')">ğŸ—‘</div>
    </div>
  `).join('');
}
function deleteSaved(id) {
  saved = saved.filter(s=>s.id!==id);
  localStorage.setItem('otpf_saved',JSON.stringify(saved));
  renderSaved(); renderList();
}

// â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMap() {
  const canvas = document.getElementById('mapCanvas');
  const cont = document.getElementById('mapContainer');
  canvas.width = cont.offsetWidth;
  canvas.height = cont.offsetHeight;
  const ctx = canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;

  ctx.fillStyle='#0b1120'; ctx.fillRect(0,0,W,H);

  // Road grid
  ctx.strokeStyle='#1c2637'; ctx.lineWidth=10;
  [0.25,0.5,0.75].forEach(r=>{
    ctx.beginPath();ctx.moveTo(0,H*r);ctx.lineTo(W,H*r);ctx.stroke();
    ctx.beginPath();ctx.moveTo(W*r,0);ctx.lineTo(W*r,H);ctx.stroke();
  });

  if (showHeat && userLat) {
    spots.forEach(s=>{
      const scale=1200;
      const cx=W/2+(s.lon-userLon)*scale;
      const cy=H/2-(s.lat-userLat)*scale;
      if (cx<-50||cx>W+50||cy<-50||cy>H+50) return;
      const r=50;
      const g=ctx.createRadialGradient(cx,cy,0,cx,cy,r);
      g.addColorStop(0, heatColor(s.busy)+'66');
      g.addColorStop(1,'transparent');
      ctx.fillStyle=g;
      ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fill();
    });
  }

  // Spot dots
  spots.forEach(s=>{
    if (!userLat) return;
    const scale=1200;
    const cx=W/2+(s.lon-userLon)*scale;
    const cy=H/2-(s.lat-userLat)*scale;
    if (cx<0||cx>W||cy<0||cy>H) return;
    ctx.beginPath();ctx.arc(cx,cy,7,0,Math.PI*2);
    ctx.fillStyle=heatColor(s.busy);ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=1.5;ctx.stroke();
  });

  // You are here
  ctx.beginPath();ctx.arc(W/2,H/2,18,0,Math.PI*2);
  ctx.fillStyle='rgba(59,130,246,0.2)';ctx.fill();
  ctx.beginPath();ctx.arc(W/2,H/2,8,0,Math.PI*2);
  ctx.fillStyle='#3b82f6';ctx.fill();
  ctx.strokeStyle='white';ctx.lineWidth=2;ctx.stroke();
}

// â”€â”€ SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSheet(s) {
  const b = document.getElementById('sheetBody');
  const openChip = s.open===true ? '<div class="schip" style="color:#86efac;border-color:#22c55e33">âœ… Open Now</div>'
    : s.open===false ? '<div class="schip" style="color:#fca5a5;border-color:#ef444433">âŒ Closed</div>'
    : '<div class="schip">ğŸ• Hours Unknown</div>';
  const priceChip = s.isFree
    ? '<div class="schip" style="color:#86efac;border-color:#22c55e33">ğŸ’š Free Parking</div>'
    : `<div class="schip" style="color:#fcd34d;border-color:#f59e0b33">ğŸ’³ ${s.priceLevel?'$'.repeat(s.priceLevel)+'/hr est.':'Paid'}</div>`;
  const winterChip = s.hasWinter ? '<div class="schip" style="color:#7dd3fc;border-color:#3b82f633">â„ï¸ Winter Restrictions</div>' : '';
  const busyChip = `<div class="schip">${s.busy<0.4?'ğŸŸ¢ Usually easy':s.busy<0.7?'ğŸŸ¡ Moderate traffic':'ğŸ”´ Often busy'}</div>`;

  b.innerHTML = `
    <div class="sheet-header">
      <div class="sheet-icon-wrap ${s.type}">${typeIcon(s.type)}</div>
      <div class="sheet-title-block">
        <div class="sheet-name">${s.name}</div>
        <div class="sheet-addr">ğŸ“ ${s.address}</div>
      </div>
    </div>
    <div class="sheet-stats">
      <div class="sstat">
        <div class="sstat-val" style="color:#60a5fa">${fmtDist(s)}</div>
        <div class="sstat-lbl">Distance</div>
      </div>
      <div class="sstat">
        <div class="sstat-val" style="color:#5eead4">${s.walk}m</div>
        <div class="sstat-lbl">Walk</div>
      </div>
      <div class="sstat">
        <div class="sstat-val" style="color:#fcd34d">${s.rating||'â€”'}</div>
        <div class="sstat-lbl">Rating</div>
      </div>
    </div>
    <div class="sheet-chips">
      ${openChip}${priceChip}${busyChip}${winterChip}
      <div class="schip">${typeName(s.type)}</div>
      ${s.is_ev && s.numPoints ? `<div class="schip">ğŸ”Œ ${s.numPoints} charge point${s.numPoints>1?'s':''}</div>` : ''}
      ${s.is_ev && s.connectors && s.connectors.length ? `<div class="schip">ğŸ”‹ ${s.connectors.join(', ')}</div>` : ''}
      ${s.is_ev && s.network ? `<div class="schip">ğŸ¢ ${s.network}</div>` : ''}
      ${s.is_ev && s.usageCost ? `<div class="schip">ğŸ’° ${s.usageCost}</div>` : ''}
    </div>
    <div class="sheet-btns">
      <button class="sbtn sbtn-primary" onclick="driveToSpot(${s.lat},${s.lon})">ğŸ§­ Drive There</button>
      <button class="sbtn sbtn-walk" onclick="walkToSpot(${s.lat},${s.lon})">ğŸš¶ Walk</button>
      <button class="sbtn sbtn-save" onclick="toggleSave(event,'${s.id}')">${isSaved(s.id)?'â­':'â˜†'}</button>
      <button class="sbtn sbtn-close" onclick="closeSheet()">âœ•</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('open');
  document.getElementById('sheet').classList.add('open');
}
function closeSheet() {
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('sheet').classList.remove('open');
}
function driveToSpot(lat,lon) {
  closeSheet();
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`,'_blank');
}
function walkToSpot(lat,lon) {
  closeSheet();
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=walking`,'_blank');
}

// â”€â”€ VOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg) {
  const t = document.getElementById('voiceToast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 2800);
}

function startVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    toast('âŒ Voice not supported in this browser. Try Chrome or Safari.');
    return;
  }

  // If already listening, stop
  if (recog) {
    recog.stop();
    recog = null;
    document.getElementById('voiceBtn').classList.remove('listening');
    return;
  }

  recog = new SR();
  recog.continuous = false;
  recog.interimResults = false;
  recog.lang = 'en-US';
  recog.maxAlternatives = 3;

  document.getElementById('voiceBtn').classList.add('listening');
  toast('ğŸ™ï¸ Listeningâ€¦ speak now');

  recog.onresult = (e) => {
    const cmd = e.results[0][0].transcript.toLowerCase().trim();
    toast(`"${cmd}"`);
    handleCmd(cmd);
  };

  recog.onerror = (e) => {
    document.getElementById('voiceBtn').classList.remove('listening');
    recog = null;
    if (e.error === 'not-allowed') {
      toast('âŒ Microphone blocked â€” allow mic in browser settings');
    } else if (e.error === 'no-speech') {
      toast('âŒ No speech detected. Try again.');
    } else {
      toast('âŒ Voice error: ' + e.error);
    }
  };

  recog.onend = () => {
    document.getElementById('voiceBtn').classList.remove('listening');
    recog = null;
  };

  // Start with a slight delay to ensure UI updates first
  setTimeout(() => {
    try { recog.start(); }
    catch(e) { toast('âŒ Could not start mic. Try again.'); recog = null; }
  }, 100);
}

function handleCmd(cmd) {
  if (/find|search|parking|park/.test(cmd)) {
    findParking();
    toast('âœ… Searching for parkingâ€¦');
  } else if (/free/.test(cmd)) {
    setChip(document.querySelectorAll('.chip')[3], 'free');
    toast('âœ… Showing free spots');
  } else if (/paid|meter|cost/.test(cmd)) {
    setChip(document.querySelectorAll('.chip')[4], 'paid');
    toast('âœ… Showing paid spots');
  } else if (/map/.test(cmd)) {
    setView('map'); toast('âœ… Map view');
  } else if (/list/.test(cmd)) {
    setView('list'); toast('âœ… List view');
  } else if (/nearest|closest|first/.test(cmd)) {
    if (spots.length) openSheet(spots[0]);
    else toast('âŒ No spots loaded yet');
  } else if (/navigate|drive|direction/.test(cmd)) {
    if (spots.length) driveToSpot(spots[0].lat, spots[0].lon);
    else toast('âŒ No spots loaded yet');
  } else if (/walk/.test(cmd)) {
    if (spots.length) walkToSpot(spots[0].lat, spots[0].lon);
    else toast('âŒ No spots loaded yet');
  } else if (/km|kilomet/.test(cmd)) {
    setUnit('km'); toast('âœ… Switched to kilometres');
  } else if (/mile/.test(cmd)) {
    setUnit('mi'); toast('âœ… Switched to miles');
  } else if (/save|star|favourite/.test(cmd)) {
    if (spots.length) { toggleSave({stopPropagation:()=>{}}, spots[0].id); toast('âœ… Saved nearest spot'); }
    else toast('âŒ No spots loaded yet');
  } else if (/winter|snow/.test(cmd)) {
    togglePanel('winterPanel','winHBtn'); toast('âœ… Winter panel toggled');
  } else if (/help|tutorial/.test(cmd)) {
    showTut();
  } else {
    toast('ğŸ¤· Try: "find parking", "show free", "navigate", "show map", "save nearest"');
  }
}
</script>
</body>
</html>
